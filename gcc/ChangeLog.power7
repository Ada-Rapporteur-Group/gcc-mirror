2010-07-26  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Merge up to 162542.
	* REVISION: Update subversion id.

2010-07-21  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/vector.md (vector_copysign<mode>3): Use UNSPEC
	instead of doing the RTL to avoid -0 problems.
	* config/rs6000/vsx.md (vsx_copysign<mode>3): Ditto.
	* config/rs6000/rs6000.md (copysign<mode>3_fcpsgn): Ditto.

	* config/rs6000/rs6000-protos.h (rs6000_address_for_fpconvert):
	Rename from rs6000_make_indexed_or_indirect_address.
	(rs6000_allocate_stack_temp): New declaration.

	* config/rs6000/rs6000.c (rs6000_address_for_fpconvert):
	Rename from rs6000_make_indexed_or_indirect_address.  On 32-bit,
	don't allow REG+REG addresses for 64-bit memory.  Use
	rs6000_allocate_stack_temp to return a stack temp that is either
	offettable or setup for REG+REG addressing.
	(rs6000_allocate_stack_temp): Ditto.
	(rs6000_expand_convert_si_to_sfdf): Use
	rs6000_address_for_fpconvert and rs6000_allocate_stack_temp as
	appropriate.
	* config/rs6000/rs6000.md (floatsi<mode>2_lfiwax): Ditto.
	(floatunssi<mode>2_lfiwzx): Ditto.
	(fix_trunc<mode>si2): Ditto.
	(fixuns_trunc<mode>si2): Ditto.

	* config/rs6000/vsx.md (vsx_floatsidf2): Go back to requiring
	input to be in a register.
	(vsx_floatunssidf2): Ditto.
	(<vsx_floatuns<VSi><mode>2): Reformat a long line.

	* config/rs6000/rs6000.md (UNSPEC_COPYSIGN): New unspec #.
	(floatsidf2): Make scratch stack address offsetable.
	(fix_truncdfdi2): Convert to define_expand to allow for VSX
	support.
	(fix_truncdfdi2_fpr): Non-VSX insn for fix_truncdfdi2.
	(floatdidf2): Go back to requiring input be in a register.
	(floatdidf2_fcfid): Ditto.
	(floatunsdidf2): Ditto.
	(floatunsdidf2_fdfidu): Ditto.
	(floatdisf2): Ditto.
	(floatdisf2_fcfids): Ditto.
	(floatunsdisf2): Ditto.
	(floatunsdisf2_fcfidus): Ditto.
	(floatdidf2_mem): New combiner pattern to merge load and convert
	to reduce the number of store-load hits caused by loading the
	value into a GPR, then storing it on the stack, and reloading it.
	(floatunsdidf2_mem): Ditto.
	(floatdisf2_mem): Ditto.
	(floatunsdisf2_mem): Ditto.
	(floatunsdidf2_fcfidu): Rename from floatunsdidf2_fdfidu.
	(fix_trunc<mode>si2_stfiwx2): Remove gen_ function.  Turn into
	combiner pattern.
	(fixuns_trunc<mode>si2_stfiwx2): Ditto.
	(fix_trunc<mode>si2): Go back to taking a register as input.
	(fixuns_trunc<mode>si2): Ditto.

2010-07-19  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Merge up to version 162317.
	* REVISION: Update subversion id.

	* config/rs6000/rs6000-protos.h
	(rs6000_make_indexed_or_indirect_address): New declaration.

	* config/rs6000/rs6000.c
	(rs6000_make_indexed_or_indirect_address): Function to convert a
	memory address to REG+REG addressing for STFIWX/LFIWAX/LRIWZX.
	(rs6000_expand_convert_si_to_sfdf): Change name/signature of insn
	that does the conversion and stores the result to memory.  Insure
	the address uses REG+REG addressing.

2010-07-15  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/vsx.md (UNSPEC_VSX_XXSPLTW): Define.
	(vsx_xscvdpsxws): New insn, mirror fctiwz for VSX.
	(vsx_xscvdpuxws): New insn, mirror fctiwuz for VSX.
	(vsx_xscvspdp_sf): New insn, with SF mode target.
	(vsx_floatsf_fixsisf2): Rework floating round optimizations.
	(vsx_floatunsdf_fixunssidf2): Ditto.
	(vsx_xvcvsxwdp_df): Move location in file.
	(vsx_xxspltw_di): New insn, to splat a SImode in a DImode value.

	* config/rs6000/rs6000.md (fix_trunc<mode>si2_stfiwx): Make stack
	temp use reg+reg addressing.
	(fixuns_trunc<mode>si2_stfiwx): Ditto.
	(fix_trunc<mode>si2_stfiwx2): Clone from
	fix_trunc<mode>si2_stfiwx, removing the stack temp argument.
	(fixuns_trunc<mode>si2_stfiwx2): Clone from
	fixuns_trunc<mode>si2_stfiwx, removing the stack temp argument.
	(fix_truncdfsi2): Make stack temp use reg+reg addressing.  If
	operand0 is a memory, avoid using a stack temp.
	(fixuns_truncdfsi2): Ditto.
	(fctiwz_<mode>): Split into separate define_expand, define_insn
	and for the define_insn exclude VSX.
	(fctiwuz_<mode>): Ditto.

2010-07-14  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/vsx.md (vsx_copysignsf3): Delete, use fcpsgn
	instead.

	* config/rs6000/rs6000.md (TARGET_FLOAT): New mode attribute for
	appropriate TARGET_{SINGLE,DOBULE}_FLOAT test.
	(copysign<mode>3): Fold copysignsf3/copysigndf3 into one pattern.
	Add support for ISA 2.05 fcpsgn instruction.
	(copysignsf3): Delete, fold into copysign<mode>3.
	(copysigndf3): Ditto.
	(copysign<mode>3_fcpsgn): New support for ISA 2.05 fcpsgn instruction.

	Merge up to 162191.
	* REVISION: Update subversion id.

2010-07-09  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/rs6000.opt (-mfriz): Enable by default.

	* config/rs6000/vsx.md (vsx_floatdf_fixsidf2): Add VSX specific
	optimization for converting to int and back to a floating point
	type.
	(vsx_floatsf_fixsisf2): Ditto.
	(vsx_xvcvsxwdp_df): Ditto.
	(vsx_floatunssf_fixunssisf2): Ditto.
	(vsx_xvcvuxwdp_df): Ditto.

	* config/rs6000/rs6000.md (float<mode>_fixsisf2): Delete, since
	the FCTIWZ instruction leaves garbage in the upper 32-bits.
	(float<mode>_fixsidf2): Ditto.
	(float<mode>_fixdisf2): Fix pattern matching.
	(float<mode>_fixdidf2): Make sure we don't match if FRIZ would be
	used.

	Merge up to subversion id 162003.
	* REVISION: Update subversion id.

	* config/rs6000/rs6000.opt (-mfriz): Add temporary debug switch.

	* config/rs6000/vsx.md (vsx_float_fix_<mode>2): Use -mfriz switch.
	* config/rs6000/rs6000.md (friz): Ditto.

2010-07-07  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Merge up to subversion id 161930.
	* REVISION: Update subversion id.

2010-07-06  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Recreate branch, based off of subversion id 161886.
	* REVISION: Update subversion id.

2010-07-02  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/rs6000.c (rs6000_expand_convert_si_to_sfdf): Don't
	expand the insn immediately, generate an insn with clobbers that
	will be split later.

	* config/rs6000/vsx.md (VSX_DF): New iterator.
	(vsx_float_fix_<mode>2): Optimize (double)(long) into a single
	instruction.
	* config/rs6000/rs6000.md (friz): Ditto.

	* config/rs6000/rs6000.md (SI_CONVERT_FP): New mode attribute, to
	for the fcfid/fcfids instruction being availble.
	(SIGN_SI_CVT_FP): Delete.
	(UNS_SI_CVT_FP): Delete.
	(E500_CONVERT): New mode attribute for E500 floating point
	conversions.
	(fix_truncsfsi2): Add support for power7.
	(lfiwax): Create generator function.
	(floatsi<mode>2_lfiwax): Rewrite insn to take the memory argument
	as a clobber, and split later.
	(floatunssi<mode2>_lfiwzx): Ditto.
	(floatsi<mode2>_lfiwax_ext): New combiner insn to combine memory
	reference and sign extend.
	(floatunssi<mode2>_lfiwzx_ext): Ditto.
	(fix_trunc<mode>si2_stfiwx): New combined insn to support
	truncation to SI mode to use the STFIWX instruction.
	(fix_truncdfsi2): Rewrite STFIWX support.
	(fix_truncdfsi2_internal): Only enable if no STFIWX instruction.
	Change name of FCTIWZ insn.
	(fix_truncdfsi2_internal_gfxopt): Delete.
	(fix_truncdfsi2_mfpgpr): Ditto.
	(fixuns_trunc<mode>si2_stfiwx): New insn for floating point to
	unsigned conversions on power7.
	(fixuns_trunc<mode>si2): Replace fixuns_truncsfsi2,
	fixuns_truncdfsi2 with combined insn, and add power7 support.
	(fctiwz_<mode>): Rename from fctiwz, and add both SF/DF support.
	(fctiwuz_<mode>): New insn for power7 support.
	(float<mode>_fixsisf2): New combined insn to optimize doint double
	to int to double type conversions to prevent the compiler from
	storing the intermediate value on the stack and reloading it.
	(float<mode>_fixsidf2): Ditto.
	(float<mode>_fixdisf2): Ditto.
	(float<mode>_fixdidf2): Ditto.
	(fix_trunctfsi2_internal): Change name of FCTIWZ insn.

2010-06-30  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Merge up to 161633.
	* REVISION: Update subversion id.

2010-06-30  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/rs6000.h (TARGET_STFIWX): New macro.
	(TARGET_FCTIDUZ): Ditto.
	(TARGET_FCTIWUZ): Ditto.

	* config/rs6000/rs6000.md (fix_truncdfdi2): Use TARGET_FCFID and
	TARGET_FCFIDS instead of TARGET_POWERPC64 for modern machines that
	support FCFID and friends in 32-bit mode.
	(fix_truncdfdi2_fpr): Ditto.
	(floatdisf2): Ditto.
	(floatdisf2_internal1): Ditto.

2010-06-29  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Merge up to 161543.
	* REVISION: Update subversion id.

2010-06-25  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/rs6000-protos.h
	(rs6000_expand_convert_si_to_sfdf): Add declaration.

	* config/rs6000/rs6000.opt (-mfcfid): New switch.

	* config/rs6000/rs6000.c (rs6000_override_options): Default
	-mfcfid for power*.
	(rs6000_expand_convert_si_to_sfdf): New function to expand SImode
	to SF/DFmode.

	* config/rs6000/rs6000.md (VSr2): Use "ws", not "!f#r".
	(VSr3): Use "ws", not "!d#r".
	(vsx_float<VSi><mode>2): Limit expander to just vectors.
	(vsx_floatuns<VSi><mode>2): Ditto.
	(vsx_floatdidf2): Use nonimmediate_operand for source to suppress
	value being loaded into a GPR and then spilled to the stack.
	(vsx_floatunsdidf2): Ditto.

	* config/rs6000/rs6000.h (TARGET_FCFID): New target macro for
	instruction support based on switches.
	(TARGET_LFIWAX): Ditto.
	(TARGET_LFIWZX): Ditto.
	(TARGET_FCFIDS): Ditto.
	(TARGET_FCFIDU): Ditto.
	(TARGET_FCFIDUS): Ditto.

	* config/rs6000/rs6000.md (UNSPEC_LFIWAX): New unspec number.
	(UNSPEC_LFIWZX): Ditto.
	(SFDF): New iterator.
	(rreg2): New mode attribute.
	(SIGN_SI_CVT_FP): Ditto.
	(UNS_SI_CVT_FP): Ditto.
	(rsqrt<mode>2): Use RS6000_RECIP_HAVE_RSQRTE_P.
	(lfiwax): New insn for SImode -> SFmode/DFmode converts.
	(floatsi<mode>2_lfiwax): Ditto.
	(lfiwzx): Ditto.
	(floatunssi<mode>2_lfiwzx): Ditto.
	(floatsidf2): Add support for the lfiwax/lfiwzx instructions, and
	-mfcfid.
	(floatsidf2_internal): Ditto.
	(floatunssidf2): Ditto.
	(floatunssidf2_internal): Ditto.
	(stfiwx): Be compatible with other fp insns, and test for
	TARGET_HARD_FLOAT, TARGET_FPRS, etc.
	(floatdidf2): Add support for -mfcfid.  Change from
	gpc_reg_operand to nonimmediate_operand to prevent stuff being
	loaded into a GPR and then spilled to the stack to move to FPR.
	(floatunsdidf2): Add support for fcfidu.
	(floatunsdidf2_fdfidu): Ditto.
	(fix_truncdfdi2_fpr): Change constraint from "!d#r" to "d".
	(floatdisf2): Add support for fcfids.
	(floatdisf2_fcfids): Ditto.
	(floatdisf2_internal1): Ditto.
	(floatunsdisf2): Add support for fcfidus.

	* doc/invoke.texi (-mfcfid): Document.

2010-06-22  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Merge up to subversion id 161215.
	* REVISION: Update subversion id.

2010-06-11  Michael Meissner  <meissner@linux.vnet.ibm.com>

	* config/rs6000/rs6000.md (UNSPEC_FCTIW): New insns.
	(UNSPEC_FCTID): Ditto.
	(lrintdfdi2): New insn to support lrint builtin.
	(fctiw): New insn, eventually for lrintf builtin.
	(movdi_mfpgpr): Add VSX support.
	(movdi_internal64): Ditto.

2010-06-04  Michael Meissner  <meissner@linux.vnet.ibm.com>

	Recreate branch, based off of subversion id 160284.
	* REVISION: New file, set for branch.

